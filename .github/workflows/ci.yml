name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  workflow_call:
    inputs:
      skip-build-test:
        description: "Skip build-test jobs (caller does its own builds)"
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: python

    steps:
      - uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: "3.13"
          cache: pip
          cache-dependency-path: python/pyproject.toml

      - name: Install ruff
        run: pip install "ruff==0.15.1"

      - name: Check formatting
        run: ruff format --check src/ tests/ scripts/

      - name: Lint
        run: ruff check src/ tests/ scripts/

  spell-check:
    name: Spell Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: crate-ci/typos@78bc6fb2c0d734235d57a2d6b9de923cc325ebdd # v1

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: python

    steps:
      - uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: "3.13"
          cache: pip
          cache-dependency-path: python/pyproject.toml

      - name: Install dependencies
        run: pip install -e ".[dev]" "pip-audit==2.10.0"

      - name: Run pip-audit
        run: |
          # CVE-2024-23342: timing attack in ecdsa (dep of tlslite-ng).
          # No fix available as of 2026-02 -- ecdsa maintainers consider side-channel
          # attacks out of scope for pure-Python implementation.
          # Tracking: https://github.com/tlsfuzzer/python-ecdsa/issues/339
          # Re-evaluate: when ecdsa > 0.19.1 is released or tlslite-ng drops ecdsa dep.
          # Last checked: 2026-02-12
          pip-audit --skip-editable --ignore-vuln CVE-2024-23342

  dependency-review:
    name: Dependency Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4
        with:
          fail-on-severity: moderate
          allow-licenses: >-
            Apache-2.0, MIT, BSD-2-Clause, BSD-3-Clause, ISC, PSF-2.0,
            MPL-2.0, LGPL-2.1-only, LGPL-2.1-or-later, LGPL-3.0-only,
            0BSD, Unlicense, CC0-1.0

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: python

    steps:
      - uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: "3.13"
          cache: pip
          cache-dependency-path: python/pyproject.toml

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run pyright
        run: pyright src/

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: python

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    steps:
      - uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: python/pyproject.toml

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests
        run: pytest -v --junitxml=junit.xml

      - name: Test Summary
        uses: test-summary/action@31493c76ec9e7aa675f1585d3ed6f1da69269a86 # v2
        with:
          paths: python/junit.xml
        if: always()

      - name: Coverage Summary
        if: matrix.python-version == '3.13' && always()
        run: |
          echo '## Coverage Report' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          coverage report --format=markdown >> $GITHUB_STEP_SUMMARY

  validate-manifests:
    name: Validate Manifests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Check MSIX PLACEHOLDER
        run: |
          # MSIX / Windows Store submission is deferred. Warn but never block.
          if grep -q 'CN=PLACEHOLDER' python/msix/AppxManifest.xml; then
            echo "::warning::MSIX AppxManifest.xml contains CN=PLACEHOLDER -- update before Windows Store submission"
          fi

      - name: Check Flatpak null commits
        run: |
          # The in-repo manifest is a reference template. The actual Flathub
          # submission uses a separate repo (flathub/io.github.lobotomoe.revenant)
          # where the commit hash is filled in after tagging. Warn but don't block.
          if grep -q 'commit: null' python/flatpak/io.github.lobotomoe.revenant.yml; then
            echo "::warning::Flatpak manifest has null commit hashes -- update the Flathub repo after tagging"
          fi

      - name: Check invalid SHA256 hashes
        run: |
          # Extract sha256 values and verify they're valid hex (or all zeros for TODO placeholders)
          hashes=$(grep -oP 'sha256:\s*\K[^\s]+' python/flatpak/io.github.lobotomoe.revenant.yml || true)
          for hash in $hashes; do
            if ! echo "$hash" | grep -qP '^[0-9a-f]{64}$'; then
              echo "::error::Invalid SHA256 hash in Flatpak manifest: $hash"
              exit 1
            fi
          done
          echo "All SHA256 hashes are valid hex"

  package:
    name: Package (sdist + wheel)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: "3.13"
          cache: pip
          cache-dependency-path: python/pyproject.toml

      - name: Install build tools
        run: pip install "build==1.4.0"

      - name: Build sdist and wheel
        run: python -m build python/

      - name: Verify wheel contents
        run: |
          pip install python/dist/*.whl
          python -c "import revenant; print(revenant.__version__)"

  build-test:
    name: Build Test
    if: ${{ !inputs.skip-build-test }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    defaults:
      run:
        working-directory: python

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: "3.13"
          cache: pip
          cache-dependency-path: python/pyproject.toml

      - name: Install dependencies
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            pip install -e ".[build-win]"
          else
            pip install -e ".[build]"
          fi

      - name: Build CLI binary
        run: python scripts/build.py cli

      - name: Test CLI binary (Unix)
        if: runner.os != 'Windows'
        run: ./dist/revenant --help

      - name: Test CLI binary (Windows)
        if: runner.os == 'Windows'
        run: ./dist/revenant-standalone/revenant.exe --help
